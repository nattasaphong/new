<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>ปฏิทินยืมเครื่อง (หลายชื่อ / Google Sheets ฟรี)</title>

<style>
* { box-sizing: border-box; }
body {
  font-family: "Segoe UI", Tahoma, sans-serif;
  margin: 20px;
  background: #f7f9fc;
  color: #333;
}

.header { display: flex; gap: 10px; margin-bottom: 15px; }
select { padding: 6px 10px; border-radius: 6px; }

.container {
  display: grid;
  grid-template-columns: 2.2fr 1fr;
  gap: 20px;
}

table {
  width: 100%;
  border-collapse: collapse;
  background: white;
  border-radius: 10px;
}
th {
  background: #4f7cff;
  color: white;
  padding: 10px;
}
td {
  border: 1px solid #e5e7eb;
  height: 120px;
  padding: 6px;
  vertical-align: top;
  cursor: pointer;
  position: relative;
}
td:hover { background: #f1f5ff; }

.day {
  position: absolute;
  right: 8px;
  top: 6px;
  font-weight: bold;
}
.farmer {
  margin-top: 26px;
  background: #e8f0ff;
  padding: 3px 6px;
  border-radius: 6px;
  font-size: 12px;
  margin-bottom: 3px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.today { background: #fff1f2; }
.selected { outline: 2px solid #4f7cff; }

.panel {
  background: white;
  border-radius: 12px;
  padding: 15px;
}
.panel h3 { margin-top: 0; color: #4f7cff; }
.panel label { display: block; margin-top: 10px; font-weight: bold; }
.panel textarea {
  width: 100%;
  padding: 7px;
  margin-top: 4px;
  min-height: 120px;
}
</style>
</head>

<body>

<div class="header">
  <label>ปี:</label>
  <select id="yearSelect"></select>

  <label>เดือน:</label>
  <select id="monthSelect"></select>
</div>

<div class="container">

<table>
  <thead>
    <tr>
      <th>อา.</th><th>จ.</th><th>อ.</th>
      <th>พ.</th><th>พฤ.</th><th>ศ.</th><th>ส.</th>
    </tr>
  </thead>
  <tbody id="calendarBody"></tbody>
</table>

<div class="panel">
  <h3 id="panelDate">เลือกวันที่</h3>

  <label>รายการเกษตรกร</label>
  <textarea id="detailBox" disabled></textarea>
</div>

</div>

<script>
/* ================= CONFIG ================= */
const CSV_URL =
"https://docs.google.com/spreadsheets/d/e/2PACX-1vTBGwUd65F_hbJmqGHeO9nPLtTxHbVeFa9BFOAn8yEvdJtHtUUR_7vvcowvIyFmnW2Fh-dr3CJ0G_Sl/pub?output=csv";

/* ================= GLOBAL ================= */
const monthNames = [
  "มกราคม","กุมภาพันธ์","มีนาคม","เมษายน",
  "พฤษภาคม","มิถุนายน","กรกฎาคม","สิงหาคม",
  "กันยายน","ตุลาคม","พฤศจิกายน","ธันวาคม"
];

const today = new Date();
const yearSelect = document.getElementById("yearSelect");
const monthSelect = document.getElementById("monthSelect");
const calendarBody = document.getElementById("calendarBody");
const detailBox = document.getElementById("detailBox");
const panelDate = document.getElementById("panelDate");

let sheetData = {};
let selectedKey = "";

/* ================= DATE CONVERT ================= */
function thaiDateToKey(dateStr) {
  if (!dateStr) return null;
  const dmy = dateStr.split(" ")[0];
  const [d, m, y] = dmy.split("/");
  const yy = parseInt(y) - 543;
  return `${yy}-${String(m).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
}

/* ================= LOAD CSV ================= */
async function loadCSV() {
  const res = await fetch(CSV_URL);
  const text = await res.text();

  const rows = text
    .split("\n")
    .map(r => r.replace(/\r/g,""))
    .map(r => r.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g));

  rows.slice(1).forEach(r => {
    if (!r || r.length < 4) return;

    const name    = r[0]?.replace(/"/g,"").trim();
    const borrow  = r[1]?.replace(/"/g,"").trim();
    const plant   = r[2]?.replace(/"/g,"").trim();
    const harvest = r[3]?.replace(/"/g,"").trim();

    const key = thaiDateToKey(borrow);
    if (!key) return;

    if (!sheetData[key]) sheetData[key] = [];

    sheetData[key].push({ name, borrow, plant, harvest });
  });

  console.log("โหลดข้อมูลแล้ว:", sheetData);
}

/* ================= INIT SELECT ================= */
for (let y = today.getFullYear()-2; y <= today.getFullYear()+2; y++) {
  const o = document.createElement("option");
  o.value = y;
  o.text = y + 543;
  if (y === today.getFullYear()) o.selected = true;
  yearSelect.appendChild(o);
}

monthNames.forEach((m,i)=>{
  const o = document.createElement("option");
  o.value=i; o.text=m;
  if (i===today.getMonth()) o.selected=true;
  monthSelect.appendChild(o);
});

yearSelect.onchange = renderCalendar;
monthSelect.onchange = renderCalendar;

/* ================= RENDER CALENDAR ================= */
function renderCalendar() {
  calendarBody.innerHTML = "";

  const y = +yearSelect.value;
  const m = +monthSelect.value;

  const firstDay = new Date(y, m, 1).getDay();
  const daysInMonth = new Date(y, m+1, 0).getDate();

  let day = 1;

  for (let w=0; w<6; w++) {
    const tr = document.createElement("tr");

    for (let d=0; d<7; d++) {
      const td = document.createElement("td");

      if ((w===0 && d<firstDay) || day>daysInMonth) {
        td.innerHTML = "";
      } else {
        const key =
          `${y}-${String(m+1).padStart(2,"0")}-${String(day).padStart(2,"0")}`;

        td.innerHTML = `<span class="day">${day}</span>`;

        if (sheetData[key]) {
          sheetData[key].forEach(item => {
            td.innerHTML += `<div class="farmer">${item.name}</div>`;
          });
        }

        td.dataset.key = key;
        td.onclick = selectDay;

        if (
          day === today.getDate() &&
          m === today.getMonth() &&
          y === today.getFullYear()
        ) td.classList.add("today");

        day++;
      }
      tr.appendChild(td);
    }
    calendarBody.appendChild(tr);
  }
}

/* ================= SELECT DAY ================= */
function selectDay() {
  document.querySelectorAll("td").forEach(td =>
    td.classList.remove("selected")
  );
  this.classList.add("selected");

  selectedKey = this.dataset.key;
  const [yy, mm, dd] = selectedKey.split("-");
  panelDate.innerText = `วันที่ ${dd}/${mm}/${+yy + 543}`;

  const list = sheetData[selectedKey];
  if (!list) {
    detailBox.value = "";
    return;
  }

  detailBox.value = list.map((i, idx) =>
    `${idx+1}. ${i.name}
   - วันยื่น: ${i.borrow}
   - วันเพาะ: ${i.plant}
   - วันเก็บ: ${i.harvest}`
  ).join("\n\n");
}

/* ================= START ================= */
loadCSV().then(renderCalendar);
</script>

</body>
</html>
